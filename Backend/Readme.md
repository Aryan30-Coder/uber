# Users API

## POST /users/register

Registers a new user.

- Route: POST /users/register
- Defined in: [./routes/user.routes.js](./routes/user.routes.js)
- Controller: [`userController.registerUser`](./contollers/user.controller.js)
- Service: [`userService.createUser`](./services/user.service.js)

### Description
Creates a new user record, hashes the password using [`userModel.hashedPassword`](./models/user.model.js), and returns an auth token generated by [`userSchema.methods.generateAuthToken`](./models/user.model.js).

### Request (application/json)
Body must be JSON with the following shape:

```json
{
  "fullname": {
    "firstname": "John",
    "lastname": "Doe"
  },
  "email": "john@example.com",
  "password": "plainTextPassword"
}
```

Validation rules (applied by express-validator in the route):
- `email` — must be a valid email.
- `fullname.firstname` — required, minimum length 3.
- `fullname.lastname` — minimum length 3.
- `password` — required (stored hashed by the model's `hashedPassword`).

### Successful response
- Status: 201 Created
- Body:
```json
{
  "token": "<jwt-token>",
  "user": {
    "_id": "<userId>",
    "fullname": {
      "firstname": "John",
      "lastname": "Doe"
    },
    "email": "john@example.com",
    "socketId": null
  }
}
```
Note: the returned `user` object comes from the created document; `password` is not returned by default.

### Error responses
- 400 Bad Request — returned when validation fails. Response contains `errors` array from `express-validator`.
- 500 Internal Server Error — for unexpected errors (DB errors, etc).

### Notes
- Password hashing: [`userModel.hashedPassword`](./models/user.model.js)
- Token generation: instance method [`userSchema.methods.generateAuthToken`](./models/user.model.js)
- Route handler: [`userController.registerUser`](./contollers/user.controller.js)

## POST /users/login

Authenticates a user and returns a JWT plus the user object.

- Route: POST /users/login
- Defined in: [./routes/user.routes.js](./routes/user.routes.js)
- Controller: [`userController.loginUser`](./contollers/user.controller.js)
- Model methods used: `userModel.findOne(...).select('+password')`, `user.comparePassword()`, `user.generateAuthToken()`

### Description
Verifies credentials. The controller looks up the user by email (explicitly selecting the hashed password), compares the provided password with the stored hash, and returns a JWT on success.

### Request (application/json)
Body must be JSON:

```json
{
  "email": "john@example.com",
  "password": "plainTextPassword"
}
```

Validation rules (applied by express-validator in the route):
- `email` — must be a valid email.
- `password` — required, minimum length 6.

### Successful response
- Status: 200 OK
- Body:
```json
{
  "token": "<jwt-token>",
  "user": {
    "_id": "<userId>",
    "fullname": {
      "firstname": "John",
      "lastname": "Doe"
    },
    "email": "john@example.com",
    "socketId": null
  }
}
```
Note: the `password` field is not returned (it is selected only for verification).

### Error responses
- 400 Bad Request — validation failed; response contains `errors` array.
- 401 Unauthorized — invalid email or password.
- 500 Internal Server Error — for unexpected errors (DB errors, etc).

### Notes
- The controller uses `userModel.findOne({ email }).select('+password')` to include the password for comparison.
- Password comparison uses `user.comparePassword()`.
- Token created via `user.generateAuthToken()`.

## GET /users/profile

Returns the authenticated user's profile.

- Route: GET /users/profile
- Defined in: [./routes/user.routes.js](./routes/user.routes.js)
- Controller: [`userController.getUserProfile`](./contollers/user.controller.js)
- Middleware: `authMiddleWare.authUser` (protects the route)

### Description
Retrieves the currently authenticated user. The authentication middleware reads the JWT from the cookie named `token` or the `Authorization: Bearer <token>` header, verifies it, loads the user and attaches it to `req.user`.

### Request
- No body.
- Authentication: provide JWT in cookie `token` or header `Authorization: Bearer <token>`.

### Successful response
- Status: 200 OK
- Body: the user object, e.g.:
```json
{
  "_id": "<userId>",
  "fullname": {
    "firstname": "John",
    "lastname": "Doe"
  },
  "email": "john@example.com",
  "socketId": null
}
```

### Error responses
- 401 Unauthorized — missing/invalid/blacklisted token.
- 500 Internal Server Error — unexpected errors.

### Notes
- The middleware populates `req.user` before the controller returns it.

## GET /users/logout

Logs out the user by clearing the token and blacklisting it.

- Route: GET /users/logout
- Defined in: [./routes/user.routes.js](./routes/user.routes.js)
- Controller: [`userController.LogoutUser`](./contollers/user.controller.js)
- Middleware: `authMiddleWare.authUser` (recommended to protect route)

### Description
Clears the `token` cookie, extracts the token (from cookie or Authorization header), saves it to blacklist storage (`./models/blacklistToken.model.js`) so it cannot be reused, and returns a success message.

### Request
- No body.
- Authentication: cookie `token` or header `Authorization: Bearer <token>`.

### Successful response
- Status: 200 OK
- Body:
```json
{
  "message": "Logged out successfully"
}
```

### Error responses
- 401 Unauthorized — missing/invalid token.
- 500 Internal Server Error — if token cannot be blacklisted or other server error.

### Notes
- The controller clears the cookie and persists the token in the blacklist (`./models/blacklistToken.model.js`) to invalidate it before its expiry.

## POST /captain/register

Registers a new captain.

- Route: POST /captain/register
- Defined in: [./routes/captian.routes.js](./routes/captian.routes.js)
- Controller: [`captainController.registerCaptain`](./contollers/cpatain.controller.js)
- Service: [`captainService.createCaptain`](./services/captain.service.js)
- Model: [`captainModel`](./models/captain.model.js)

### Description
Creates a new captain record, hashes the password using `captainModel.hashPassword`, and returns a JWT generated by `captain.generateAuthToken()`.

### Request (application/json)
Body must be JSON with this shape:

```json
{
  "fullname": {
    "firstname": "John",
    "lastname": "Doe"
  },
  "email": "john@example.com",
  "password": "plainTextPassword",
  "vehicle": {
    "color": "Blue",
    "plate": "ABC123",
    "capacity": 4,
    "vehicleType": "Car"
  }
}
```

Validation rules (applied by express-validator in the route):
- `email` — must be a valid email.
- `fullname.firstname` — required, minimum length 3.
- `fullname.lastname` — minimum length 3.
- `password` — required (stored hashed by the model's `hashPassword`).
- `vehicle.color` — required.
- `vehicle.plate` — required, unique.
- `vehicle.capacity` — required, must be an integer.
- `vehicle.vehicleType` — required.

### Successful response
- Status: 201 Created
- Body:
```json
{
  "token": "<jwt-token>",
  "captain": {
    "_id": "<captainId>",
    "fullname": {
      "firstname": "John",
      "lastname": "Doe"
    },
    "email": "john@example.com",
    "vehicle": {
      "color": "Blue",
      "plate": "ABC123",
      "capacity": 4,
      "vehicleType": "Car"
    },
    "socketId": null,
    "status": "inactive"
  }
}
```
Note: the returned `captain` object comes from the created document; `password` is not returned by default.

### Error responses
- 400 Bad Request — returned when validation fails. Response contains `errors` array from `express-validator`.
- 500 Internal Server Error — for unexpected errors (DB errors, etc).

### Notes
- Password hashing: `captainModel.hashPassword`
- Token generation: instance method `captain.generateAuthToken()`
- Route handler: [`captainController.registerCaptain`](./contollers/cpatain.controller.js)

## POST /captain/login

Authenticate an existing captain.

- Route: POST /captain/login
- Defined in: [./routes/captian.routes.js](./routes/captian.routes.js)
- Controller: [`captainController.loginCaptain`](./contollers/cpatain.controller.js)
- Model: [`captainModel`](./models/captain.model.js)

### Description
Verifies credentials (finds captain with email, selects password, compares hash). On success returns a JWT and the captain object and sets cookie `token`.

### Request (application/json)
```json
{
  "email": "john@example.com",    // required, valid email
  "password": "plainPassword"     // required, string, min length: 6
}
```


### Successful response
- Status: 200 OK
- Body:
```json
{
  "token": "<jwt-token>",
  "captain": {
    "_id": "<captainId>",
    "fullname": { "firstname": "John", "lastname": "Doe" },
    "email": "john@example.com",
    "vehicle": { "color": "Blue", "plate": "ABC123", "capacity": 4, "vehicleType": "Car" },
    "socketId": null,
    "status": "inactive"
  }
}
```

### Error responses
- 400 Bad Request — validation failed (response contains errors array).
- 401 Unauthorized — invalid email or password.
- 500 Internal Server Error — unexpected errors.

### Notes
- Token via captain.generateAuthToken().


## POST /captain/profile

- Route: GET /captain/profile
- Controller: captainController.getCaptainProfile
- Middleware: authMiddleWare.authCaptain

### Description
Returns authenticated captain (middleware reads JWT from cookie token or header and attaches req.captain).

### Request
no body. Provide JWT in cookie token or header.

### Successful response
- Status: 200 OK
```json
{
  "_id": "<captainId>",
  "fullname": { "firstname": "John", "lastname": "Doe" },
  "email": "john@example.com",
  "vehicle": { "color": "Blue", "plate": "ABC123", "capacity": 4, "vehicleType": "Car" },
  "socketId": null,
  "status": "inactive"
}
```

### Error responses
- 401 Unauthorized — missing/invalid/blacklisted token.
- 500 Internal Server Error.

## POST /captain/logout

- Route: GET /captain/logout
- Controller: captainController.logoutCaptain
- Middleware: authMiddleWare.authCaptain

### Description
Blacklists token and clears token cookie.

### Request
no body. Provide JWT in cookie token or header.

### Successful response
- Status: 200 OK
```json
{
  "message": "Logged out successfully"
}
```

### Error responses
- 401 Unauthorized — missing/invalid token.
- 500 Internal Server Error.